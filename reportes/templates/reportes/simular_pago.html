{% extends "reportes/base_reportes.html" %}

{% block title %}Simulación de Pago{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    
    <div class="text-center mb-8 md:mb-10">
        <h2 class="text-3xl font-bold text-primary">Finalizar Pago</h2>
        <p class="text-base-content/70 mt-2">Selecciona tu método de pago seguro.</p>
    </div>

    {% if messages %}
    <div class="mb-8 space-y-2">
        {% for message in messages %}
        <div role="alert" class="alert alert-{{ message.tags }} shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-12 gap-8 items-start">
        
        <div class="md:col-span-7 order-2 md:order-1">
            <div class="card bg-base-100 shadow-xl border border-base-200 dark:border-base-700 overflow-hidden">
                
                <div class="grid grid-cols-2 bg-base-200/50">
                    <button type="button" onclick="switchMethod('tarjeta')" id="tab-tarjeta" class="py-4 text-center font-semibold text-primary border-b-2 border-primary hover:bg-base-200 transition-all flex items-center justify-center gap-2">
                        <i class="bi bi-credit-card-2-front text-lg"></i> Tarjeta Directa
                    </button>
                    <button type="button" onclick="switchMethod('webpay')" id="tab-webpay" class="py-4 text-center font-semibold text-base-content/60 border-b-2 border-transparent hover:bg-base-200 transition-all flex items-center justify-center gap-2">
                        <i class="bi bi-shield-check text-lg"></i> Webpay
                    </button>
                </div>

                <div class="card-body p-6 sm:p-8">
                    <form id="payment-form" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="metodo_pago" id="input_metodo_pago" value="tarjeta">

                        <div id="view-tarjeta" class="transition-all duration-300 ease-in-out">
                            <div class="flex justify-between items-start mb-6">
                                <h3 class="text-lg font-bold text-base-content">Ingresa tus datos</h3>
                                <div class="flex gap-2 grayscale opacity-60 dark:opacity-40">
                                    <i class="bi bi-credit-card-2-back text-2xl"></i>
                                    <i class="bi bi-bank text-2xl"></i>
                                </div>
                            </div>

                            <div class="form-control w-full mb-4">
                                <label class="label pt-0"><span class="label-text font-medium">Titular de la Tarjeta</span></label>
                                <input type="text" id="tarjeta_nombre" name="tarjeta_nombre" 
                                       placeholder="Como aparece en el plástico" 
                                       class="input input-bordered w-full focus:input-primary transition-all card-input bg-base-100" required />
                            </div>

                            <div class="form-control w-full mb-4">
                                <label class="label"><span class="label-text font-medium">Número de Tarjeta</span></label>
                                <div class="relative">
                                    <input type="text" id="tarjeta_numero" name="tarjeta_numero" 
                                           placeholder="0000 0000 0000 0000" maxlength="19" 
                                           class="input input-bordered w-full focus:input-primary pl-11 font-mono tracking-wide text-lg card-input bg-base-100" required />
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none text-base-content/40">
                                        <i class="bi bi-credit-card text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label"><span class="label-text font-medium">Vencimiento</span></label>
                                    <input type="text" id="tarjeta_expiracion" name="tarjeta_expiracion" 
                                           placeholder="MM/AA" maxlength="5" 
                                           class="input input-bordered w-full focus:input-primary text-center card-input bg-base-100" required />
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-medium flex items-center gap-1">
                                            CVV
                                            <div class="tooltip tooltip-left" data-tip="3 dígitos al reverso">
                                                <i class="bi bi-question-circle-fill text-xs text-base-content/40 cursor-help"></i>
                                            </div>
                                        </span>
                                    </label>
                                    <div class="relative">
                                        <input type="password" id="tarjeta_cvv" name="tarjeta_cvv" 
                                               placeholder="123" maxlength="3" 
                                               class="input input-bordered w-full focus:input-primary text-center tracking-widest card-input bg-base-100" required />
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-base-content/30">
                                            <i class="bi bi-lock"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="view-webpay" class="hidden flex-col items-center justify-center animate-fade-in w-full text-center py-6">
                            
                            <div class="mb-4 text-[#FDB913]">
                                <i class="bi bi-box-arrow-up-right text-6xl"></i>
                            </div>

                            <h3 class="text-xl font-bold text-base-content mb-2">Continuar en Webpay Plus</h3>
                            
                            <p class="text-base-content/70 max-w-xs mx-auto mb-8 leading-relaxed">
                                Serás redirigido al portal seguro de Transbank. <br>
                                Allí podrás <strong>elegir tu medio de pago</strong> (Tarjeta de Crédito, Débito o Prepago) y tu banco.
                            </p>

                            <div class="w-full max-w-[320px] mx-auto">
                                <div class="alert bg-blue-50 text-blue-900 dark:bg-blue-900/20 dark:text-blue-100 border-none text-xs flex justify-start items-center p-3 text-left shadow-sm">
                                    <i class="bi bi-shield-lock-fill text-lg shrink-0 text-[#E3001B] dark:text-[#ff4b5c]"></i>
                                    <div>
                                        <span class="font-bold block">Transacción Segura</span>
                                        Tus datos financieros no se guardan en nuestro sitio.
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="mt-8 md:hidden">
                            <button type="submit" id="btn-submit-mobile" class="btn btn-success text-white w-full shadow-md text-lg">
                                Pagar ${{ boleta.total_a_pagar }}
                            </button>
                            <a href="{% url 'reportes:revisar_consumo' %}" class="btn btn-ghost btn-sm w-full mt-2">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="text-center mt-6 flex items-center justify-center gap-2 text-xs text-base-content/50">
                <i class="bi bi-lock-fill"></i>
                <span>Transacciones encriptadas SSL 256-bit.</span>
            </div>
        </div>

        <div class="md:col-span-5 order-1 md:order-2">
            <div class="card bg-base-100 shadow-lg border border-primary/10 dark:border-base-700 sticky top-6">
                <div class="card-body p-6">
                    <h3 class="font-bold text-lg text-base-content/80 mb-4 pb-2 border-b border-base-200 dark:border-base-700">Resumen de Compra</h3>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="opacity-70">Nº Boleta</span>
                            <span class="font-mono bg-base-200 dark:bg-base-300 px-2 py-1 rounded text-base-content">#{{ boleta.id }}</span>
                        </div>
                        
                        <div class="flex justify-between items-center text-sm">
                            <span class="opacity-70">Cliente</span>
                            <span class="font-medium text-right text-base-content">{{ boleta.usuario.nombre|truncatechars:20 }}</span>
                        </div>
                    </div>

                    <div class="divider my-4"></div>

                    <div class="flex justify-between items-end mb-2">
                        <span class="font-bold text-lg text-base-content">Total a Pagar</span>
                        <span class="text-3xl font-extrabold text-primary">${{ boleta.total_a_pagar }}</span>
                    </div>
                    
                    <div class="hidden md:block mt-6">
                        <button type="submit" form="payment-form" id="btn-submit-desktop" class="btn btn-primary w-full shadow-lg text-lg hover:scale-[1.02] transition-transform text-white">
                            <i class="bi bi-lock-fill"></i> Confirmar Pago
                        </button>
                        
                        <a href="{% url 'reportes:revisar_consumo' %}" class="btn btn-ghost btn-sm w-full mt-3 text-base-content/60 hover:bg-base-200">
                            Cancelar operación
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ... (Lógica de inputs se mantiene igual) ...
        const inputNumero = document.getElementById('tarjeta_numero');
        const inputExpiracion = document.getElementById('tarjeta_expiracion');
        const form = document.getElementById('payment-form');
        const inputMetodo = document.getElementById('input_metodo_pago');

        if (inputNumero) {
            inputNumero.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.substring(0, 16);
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });
        }
        if (inputExpiracion) {
            inputExpiracion.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.substring(0, 4);
                if (value.length >= 3) {
                    e.target.value = value.substring(0, 2) + '/' + value.substring(2);
                } else {
                    e.target.value = value;
                }
            });
        }

        if (form) {
            form.addEventListener('submit', function(e) {
                const isWebpay = inputMetodo.value === 'webpay';
                const inputsTarjeta = document.querySelectorAll('.card-input');
                
                if (isWebpay) {
                    inputsTarjeta.forEach(input => input.disabled = false);
                    document.getElementById('tarjeta_nombre').value = "Simulación Webpay";
                    document.getElementById('tarjeta_numero').value = "4111111111111111"; 
                    document.getElementById('tarjeta_expiracion').value = "12/30"; 
                    document.getElementById('tarjeta_cvv').value = "123";
                } else {
                    if (inputNumero && !inputNumero.disabled) {
                        inputNumero.value = inputNumero.value.replace(/\s+/g, '');
                    }
                }
            });
        }
    });

    // --- LÓGICA DE CAMBIO VISUAL (Con soporte DARK MODE) ---
    function switchMethod(method) {
        const viewTarjeta = document.getElementById('view-tarjeta');
        const viewWebpay = document.getElementById('view-webpay');
        const tabTarjeta = document.getElementById('tab-tarjeta');
        const tabWebpay = document.getElementById('tab-webpay');
        const inputsTarjeta = document.querySelectorAll('.card-input');
        
        const btnDesktop = document.getElementById('btn-submit-desktop');
        const btnMobile = document.getElementById('btn-submit-mobile');
        const inputMetodo = document.getElementById('input_metodo_pago');

        inputMetodo.value = method;

        // Estilos base para los botones
        const btnBaseClasses = "btn w-full shadow-lg text-lg hover:scale-[1.02] transition-transform border-none";

        if (method === 'webpay') {
            // MOSTRAR MODO WEBPAY
            viewTarjeta.classList.add('hidden');
            viewWebpay.classList.remove('hidden');
            viewWebpay.style.display = 'flex'; 

            // Estilos Tabs (Webpay Activo)
            // Se usa bg-yellow-50 en light y un amarillo muy transparente en dark para que no moleste
            tabTarjeta.className = "py-4 text-center font-semibold text-base-content/60 border-b-2 border-transparent hover:bg-base-200 transition-all flex items-center justify-center gap-2 cursor-pointer";
            
            // AQUÍ ESTÁ EL CAMBIO IMPORTANTE DE COLOR:
            tabWebpay.className = "py-4 text-center font-bold text-[#E3001B] dark:text-[#FEBE10] bg-[#FFF8E1] dark:bg-[#FDB913]/10 border-b-2 border-[#FDB913] transition-all flex items-center justify-center gap-2 cursor-pointer";

            // Desactivar inputs
            inputsTarjeta.forEach(input => {
                input.removeAttribute('required');
                input.disabled = true;
                input.value = ""; 
            });

            // Estilo Botón Webpay (Siempre Amarillo, con texto negro para contraste)
            const btnStyle = `background-color: #FEBE10; color: #000;`;
            const btnHtml = '<span class="font-bold mr-2">Ir a Pagar</span> <i class="bi bi-arrow-right-circle-fill"></i>';

            btnDesktop.className = btnBaseClasses;
            btnDesktop.style.cssText = btnStyle;
            btnDesktop.innerHTML = btnHtml;

            btnMobile.className = btnBaseClasses;
            btnMobile.style.cssText = btnStyle;
            btnMobile.innerHTML = btnHtml;

        } else {
            // MOSTRAR MODO TARJETA
            viewWebpay.classList.add('hidden');
            viewWebpay.style.display = 'none';
            viewTarjeta.classList.remove('hidden');

            // Estilos Tabs (Tarjeta Activa)
            // En dark mode usamos bg-base-100 para la tab activa
            tabWebpay.className = "py-4 text-center font-semibold text-base-content/60 border-b-2 border-transparent hover:bg-base-200 transition-all flex items-center justify-center gap-2 cursor-pointer";
            
            tabTarjeta.className = "py-4 text-center font-bold text-primary bg-base-100 border-b-2 border-primary transition-all flex items-center justify-center gap-2 cursor-pointer";

            // Activar inputs
            inputsTarjeta.forEach(input => {
                input.setAttribute('required', '');
                input.disabled = false;
            });

            // Estilo Botón Normal (Usa variables CSS de DaisyUI, se adapta solo)
            const btnHtml = '<i class="bi bi-lock-fill mr-2"></i> Confirmar Pago';
            
            btnDesktop.style.cssText = ""; 
            btnDesktop.className = "btn btn-primary text-white w-full shadow-lg text-lg hover:scale-[1.02] transition-transform";
            btnDesktop.innerHTML = btnHtml;

            btnMobile.style.cssText = "";
            btnMobile.className = "btn btn-primary text-white w-full shadow-lg text-lg";
            btnMobile.innerHTML = btnHtml;
        }
    }
</script>
{% endblock %}