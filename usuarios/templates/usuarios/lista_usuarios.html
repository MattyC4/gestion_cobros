{% extends "usuarios/base_usuarios.html" %}

{% block title %}Lista de Usuarios{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">

    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
        <div>
            <h2 class="text-3xl font-bold text-primary">Gestión de Usuarios</h2>
            <p class="text-base-content/70 text-sm mt-1">Administra la información de los socios del APR.</p>
        </div>
        <a href="{% url 'usuarios:agregar_usuario' %}" class="btn btn-primary text-white shadow-md hover:scale-105 transition-transform">
            <i class="bi bi-person-plus-fill text-lg"></i> Agregar Usuario
        </a>
    </div>

    <div class="collapse collapse-arrow bg-base-100 border border-info/20 shadow-sm rounded-xl">
        <input type="checkbox" /> 
        <div class="collapse-title text-base font-medium flex items-center gap-2 text-info">
            <i class="bi bi-info-circle-fill"></i> ¿Qué puedes hacer aquí?
        </div>
        <div class="collapse-content text-sm text-base-content/80">
            <p class="mb-2">En esta sección puedes gestionar a los socios registrados:</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
                <li>Revisar datos de contacto (correo, teléfono).</li>
                <li>Actualizar información personal.</li>
                <li>Gestionar altas y bajas del sistema.</li>
            </ul>
        </div>
    </div>

    <div class="overflow-x-auto bg-base-100 rounded-xl border border-base-200 shadow-sm">
        <table class="table table-zebra w-full text-left">
            <thead>
                <tr class="bg-base-200 text-base-content font-bold uppercase text-xs tracking-wider">
                    <th class="py-4 pl-6">Nombre</th>
                    <th>RUT</th>
                    <th>Contacto</th>
                    <th class="text-center min-w-[120px]">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr class="hover transition-colors group">
                    
                    <td class="pl-6">
                        <div class="font-bold text-base-content">{{ usuario.nombre }}</div>
                        <div class="text-xs text-base-content/60 sm:hidden">{{ usuario.rut }}</div>
                    </td>

                    <td class="font-mono text-sm text-base-content/80">
                        {{ usuario.rut }}
                    </td>

                    <td>
                        <div class="flex flex-col text-sm">
                            <span class="flex items-center gap-2 text-base-content/80">
                                <i class="bi bi-envelope text-xs opacity-70"></i> {{ usuario.correo }}
                            </span>
                            {% if usuario.telefono %}
                            <span class="flex items-center gap-2 text-base-content/60 text-xs mt-1">
                                <i class="bi bi-telephone text-xs opacity-70"></i> {{ usuario.telefono }}
                            </span>
                            {% endif %}
                        </div>
                    </td>

                    <td class="text-center">
                        <div class="flex items-center justify-center gap-2">
                            
                            <a href="{% url 'usuarios:editar_usuario' usuario.id %}" 
                               class="btn btn-sm btn-warning text-white shadow-sm"
                               title="Editar Usuario">
                                <i class="bi bi-pencil-square"></i>
                            </a>

                            {% if request.user.rol == 'admin' %}
                            <button 
                               onclick="abrirModalEliminarUsuario(
                                   '{% url 'usuarios:eliminar_usuario' usuario.id %}', 
                                   '{{ usuario.nombre }}', 
                                   '{{ usuario.rut }}'
                               )"
                               class="btn btn-sm btn-error text-white shadow-sm"
                               title="Eliminar Usuario">
                                <i class="bi bi-trash3-fill"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center py-12">
                        <div class="flex flex-col items-center justify-center text-base-content/50">
                            <i class="bi bi-people text-4xl mb-3"></i>
                            <p class="font-medium">No se encontraron usuarios registrados.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="flex justify-start mt-2">
        <a href="{% url 'roles:redireccion_dashboard' %}" class="btn btn-ghost gap-2 text-base-content/70 hover:bg-base-200">
            <i class="bi bi-arrow-left"></i> Volver al Dashboard
        </a>
    </div>

</div>

<dialog id="modal_eliminar_usuario" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-base-100 p-8 shadow-2xl">
    
    <div class="flex flex-col items-center text-center">
        <div class="w-20 h-20 rounded-full bg-error/10 flex items-center justify-center mb-5 text-error animate-pulse">
            <i class="bi bi-person-x-fill text-4xl"></i>
        </div>

        <h3 class="font-bold text-2xl text-base-content">¿Eliminar Usuario?</h3>
        
        <p class="py-4 text-base-content/70">
            Estás a punto de eliminar a: <br>
            <strong id="modal_nombre" class="text-base-content text-lg block mt-1">Nombre Usuario</strong>
            <span id="modal_rut" class="text-sm font-mono opacity-80">RUT</span>
        </p>

        <p class="text-error text-sm font-semibold border-t border-base-200 pt-3 w-full">
            <i class="bi bi-exclamation-triangle"></i> Cuidado: Esta acción es irreversible.
        </p>
    </div>

    <div class="modal-action flex flex-col-reverse sm:flex-row gap-3 w-full mt-6">
        <form method="dialog" class="flex-1">
            <button class="btn btn-ghost w-full hover:bg-base-200">Cancelar</button>
        </form>

        <form id="form_eliminar_usuario" method="post" class="flex-1">
            {% csrf_token %}
            <button type="submit" class="btn btn-error text-white w-full shadow-md shadow-error/30">
                <i class="bi bi-trash3-fill"></i> Sí, eliminar usuario
            </button>
        </form>
    </div>
  </div>
  
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script>
    function abrirModalEliminarUsuario(urlEliminar, nombre, rut) {
        const modal = document.getElementById('modal_eliminar_usuario');
        const form = document.getElementById('form_eliminar_usuario');
        const spanNombre = document.getElementById('modal_nombre');
        const spanRut = document.getElementById('modal_rut');

        // Asignamos los datos dinámicos
        form.action = urlEliminar;
        spanNombre.innerText = nombre;
        spanRut.innerText = rut;

        // Abrimos el modal
        modal.showModal();
    }
</script>

{% endblock %}