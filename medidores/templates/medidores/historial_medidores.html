{% extends "medidores/base_medidores.html" %}

{% block title %}Historial de Medidores{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">

    <!-- Encabezado y Botón Principal -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h2 class="text-3xl font-bold text-info">Historial de Medidores</h2>
            <p class="text-base-content/70 text-sm mt-1">Registro completo de equipos y sus estados operativos.</p>
        </div>
        
        <a href="{% url 'medidores:buscar_usuario_para_medidor' %}" class="btn btn-success text-white shadow-md gap-2">
            <i class="bi bi-plus-lg"></i> Asignar Nuevo
        </a>
    </div>

    <!-- Tabla de Medidores -->
    <div class="overflow-x-auto bg-base-100 rounded-xl border border-base-200 shadow-sm pb-10">
        <table class="table table-zebra w-full text-center">
            <!-- Encabezado -->
            <thead class="bg-base-200 text-base-content font-bold uppercase text-xs tracking-wider">
                <tr>
                    <th class="py-4">Código Serial</th>
                    <th class="text-left pl-6">Usuario Asignado</th>
                    <th>Fecha Registro</th>
                    <th>Estado</th>
                    <th class="min-w-[180px]">Acciones</th>
                </tr>
            </thead>
            <!-- Cuerpo -->
            <tbody>
                {% for medidor in medidores %}
                <tr class="hover transition-colors group">
                    
                    <!-- Serial -->
                    <td class="font-mono font-bold text-info text-lg">
                        {{ medidor.codigo_serial }}
                    </td>

                    <!-- Usuario -->
                    <td class="text-left pl-6">
                        {% if medidor.usuario %}
                            <div class="font-semibold text-base-content">{{ medidor.usuario.nombre }}</div>
                            <div class="text-xs text-base-content/60 font-mono">RUT: {{ medidor.usuario.rut }}</div>
                        {% else %}
                            <div class="badge badge-ghost text-xs opacity-50">Sin asignar</div>
                        {% endif %}
                    </td>

                    <!-- Fecha -->
                    <td class="text-sm text-base-content/80">
                        {{ medidor.fecha_registro|date:"d/m/Y" }}
                    </td>

                    <!-- Estado con Badges de Colores -->
                    <td>
                        {% if medidor.estado == 'activo' %}
                            <div class="badge badge-success text-white gap-1 text-xs font-semibold">
                                <i class="bi bi-check-circle-fill"></i> Activo
                            </div>
                        {% elif medidor.estado == 'inactivo' %}
                            <div class="badge badge-neutral text-white gap-1 text-xs">
                                <i class="bi bi-dash-circle"></i> Inactivo
                            </div>
                        {% elif medidor.estado == 'mantenimiento' %}
                            <div class="badge badge-warning text-white gap-1 text-xs">
                                <i class="bi bi-tools"></i> Mantención
                            </div>
                        {% elif medidor.estado == 'danado' %}
                            <div class="badge badge-error text-white gap-1 text-xs">
                                <i class="bi bi-exclamation-triangle-fill"></i> Dañado
                            </div>
                        {% else %}
                            <div class="badge badge-ghost text-xs">{{ medidor.get_estado_display }}</div>
                        {% endif %}
                    </td>

                    <!-- Acciones -->
                    <td>
                        <div class="flex items-center justify-center gap-2">
                            
                            <!-- Cambiar Estado -->
                            <a href="{% url 'medidores:confirmar_cambio_estado' medidor.id %}" 
                               class="btn btn-sm btn-info text-white shadow-sm" title="Cambiar Estado">
                                <i class="bi bi-arrow-repeat"></i>
                            </a>

                            <!-- Eliminar (Abre Modal) -->
                            <button onclick="abrirModalEliminar('{% url 'medidores:eliminar_medidor' medidor.id %}', '{{ medidor.codigo_serial }}')" 
                               class="btn btn-sm btn-error text-white shadow-sm" title="Eliminar">
                                <i class="bi bi-trash3-fill"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-12">
                        <div class="flex flex-col items-center justify-center text-base-content/50">
                            <i class="bi bi-speedometer2 text-4xl mb-3"></i>
                            <p class="font-medium">No hay medidores registrados en el sistema.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Botón Volver -->
    <div class="flex justify-start mt-2">
        <a href="{% url 'roles:redireccion_dashboard' %}" class="btn btn-ghost gap-2 text-base-content/70 hover:bg-base-200">
            <i class="bi bi-arrow-left"></i> Volver al Dashboard
        </a>
    </div>

</div>

<!-- ========================================== -->
<!-- MODAL DE ELIMINACIÓN -->
<!-- ========================================== -->
<style>
    /* Asegura transparencia del fondo */
    dialog::backdrop {
        background-color: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(2px);
    }
</style>

<dialog id="modal_eliminar" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-base-100">
    <div class="flex flex-col items-center text-center">
        <div class="w-16 h-16 rounded-full bg-error/10 flex items-center justify-center mb-4 text-error animate-pulse">
            <i class="bi bi-trash3-fill text-3xl"></i>
        </div>
        <h3 class="font-bold text-lg text-base-content">¿Eliminar Medidor?</h3>
        <p class="py-4 text-base-content/70">
            Estás a punto de eliminar el medidor con serial: <strong class="text-base-content text-lg" id="txt_medidor_serial"></strong>.
            <br><span class="text-error text-xs font-bold uppercase mt-2 block">Esta acción no se puede deshacer.</span>
        </p>
    </div>
    
    <div class="modal-action flex flex-col-reverse sm:flex-row gap-2">
      <form method="dialog" class="flex-1">
        <button class="btn btn-ghost w-full">Cancelar</button>
      </form>
      
      <!-- Formulario POST para eliminar -->
      <form id="form_eliminar" method="post" class="flex-1">
          {% csrf_token %}
          <button type="submit" class="btn btn-error text-white w-full shadow-md">Sí, eliminar</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<!-- Script para el Modal -->
<script>
    function abrirModalEliminar(url, serial) {
        document.getElementById('txt_medidor_serial').innerText = serial;
        document.getElementById('form_eliminar').action = url;
        document.getElementById('modal_eliminar').showModal();
    }
</script>

{% endblock %}