{% extends "consumos/base_consumos.html" %}

{% block title %}Registrar Consumo{% endblock %}

{% block content %}
<div class="min-h-[60vh] max-w-4xl mx-auto flex flex-col gap-6">

    <!-- HEADER -->
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center text-primary shadow-sm">
                <i class="bi bi-droplet-fill text-2xl"></i>
            </div>
            <div>
                <h2 class="text-2xl md:text-3xl font-bold text-primary">Registrar Consumo</h2>
                <p class="text-sm text-base-content/70">
                    Ingreso manual de lectura para el socio seleccionado.
                </p>
            </div>
        </div>

        <a href="{% url 'consumos:lista_usuarios' %}"
           class="btn btn-ghost gap-2 text-base-content/80 hover:bg-base-200">
            <i class="bi bi-arrow-left"></i>
            Volver a la lista
        </a>
    </div>

    <!-- AVISO -->
    <div class="alert alert-info bg-info/10 border border-info/30 text-sm flex items-start gap-3">
        <i class="bi bi-info-circle text-lg mt-0.5"></i>
        <div>
            <span class="font-semibold">Importante:</span>
            <p class="text-base-content/80 mt-0.5">
                La lectura registrada debe ser coherente con el historial del socio.
                Se recomienda ingresar el valor total acumulado en mÂ³ segÃºn la Ãºltima visita.
            </p>
        </div>
    </div>

    <!-- TARJETA RESUMEN -->
    <div class="card bg-base-100 border border-base-200 shadow-sm">
        <div class="card-body grid md:grid-cols-4 gap-4 text-sm">

            <!-- Usuario -->
            <div class="space-y-1">
                <p class="text-[0.7rem] uppercase tracking-wide text-base-content/60">
                    Usuario
                </p>
                <p class="font-semibold text-base-content">
                    {{ usuario.nombre }}
                </p>
                <p class="font-mono text-xs text-base-content/70">
                    RUT: {{ usuario.rut }}
                </p>
            </div>

            <!-- Medidor -->
            <div class="space-y-1">
                <p class="text-[0.7rem] uppercase tracking-wide text-base-content/60">
                    Medidor activo
                </p>
                <p class="font-mono text-sm font-semibold text-base-content">
                    {{ medidor.codigo_serial }}
                </p>
                <span class="badge badge-success badge-sm mt-1">
                    <i class="bi bi-check-circle me-1"></i> Activo
                </span>
            </div>

            <!-- Tarifa -->
            <div class="space-y-1">
                <p class="text-[0.7rem] uppercase tracking-wide text-base-content/60">
                    Tarifa aplicada
                </p>
                <p class="font-semibold text-base-content">
                    ${{ tarifa.valor }}
                </p>
                <p class="text-xs text-base-content/70">
                    Vigente desde {{ tarifa.fecha_vigencia|date:"d/m/Y" }}
                </p>
            </div>

            <!-- ðŸ”¹ Ãšltima lectura -->
            <div class="space-y-1">
                <p class="text-[0.7rem] uppercase tracking-wide text-base-content/60">
                    Ãšltima lectura registrada
                </p>

                {% if ultimo_consumo %}
                    <p class="font-semibold text-base-content">
                        {{ ultimo_consumo.cantidad_consumida }} mÂ³
                    </p>
                    <p class="text-xs text-base-content/70">
                        Registrada el {{ ultimo_consumo.fecha_consumo|date:"d/m/Y" }}
                    </p>
                {% else %}
                    <p class="font-semibold text-base-content/70">
                        Sin lecturas registradas
                    </p>
                    <p class="text-xs text-base-content/60">
                        Este serÃ¡ el primer consumo para este medidor.
                    </p>
                {% endif %}
            </div>

        </div>
    </div>

    <!-- FORMULARIO -->
    <form method="post" class="card bg-base-100 border border-base-200 shadow-lg">
        {% csrf_token %}
        <div class="card-body p-6 sm:p-8 space-y-6">

            <!-- Cantidad consumida -->
            <div class="form-control">
                <label for="cantidad_consumida" class="label">
                    <span class="label-text font-semibold flex items-center gap-2">
                        <i class="bi bi-speedometer2 text-info"></i>
                        Lectura registrada (mÂ³)
                    </span>
                </label>
                <input 
                    type="number"
                    name="cantidad_consumida"
                    id="cantidad_consumida"
                    step="0.01"
                    class="input input-bordered w-full focus:input-primary"
                    placeholder="Ej: 18.75"
                    required
                >
                <label class="label">
                    <span class="label-text-alt text-base-content/70">
                        <i class="bi bi-info-circle me-1"></i>
                        Debe ser mayor o igual a la Ãºltima lectura registrada.
                    </span>
                </label>
            </div>

            <!-- Fecha -->
            <div class="form-control">
                <label for="fecha_consumo" class="label">
                    <span class="label-text font-semibold flex items-center gap-2">
                        <i class="bi bi-calendar-event text-secondary"></i>
                        Fecha del consumo
                    </span>
                </label>
                <input 
                    type="date"
                    name="fecha_consumo"
                    id="fecha_consumo"
                    class="input input-bordered w-full focus:input-primary"
                    required
                >
                <label class="label">
                    <span class="label-text-alt text-base-content/70">
                        Usa la fecha en que se tomÃ³ la lectura en terreno.
                    </span>
                </label>
            </div>

            <!-- Acciones -->
            <div class="flex flex-col-reverse sm:flex-row justify-end gap-3 pt-4 border-t border-base-200">
                <a href="{% url 'consumos:lista_usuarios' %}"
                   class="btn btn-ghost hover:bg-base-200 text-base-content/80">
                    <i class="bi bi-x-lg"></i>
                    Cancelar
                </a>

                <button type="submit"
                        class="btn btn-primary text-white shadow-md shadow-primary/30 gap-2">
                    <i class="bi bi-check-lg text-lg"></i>
                    Registrar consumo
                </button>
            </div>

        </div>
    </form>

</div>
{% endblock %}
