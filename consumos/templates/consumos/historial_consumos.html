{% extends "consumos/base_consumos.html" %}
{% load moneda %}

{% block title %}Historial de Consumos{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">

    <div class="text-center md:text-left">
        <h2 class="text-2xl font-bold text-primary">Historial de Consumos</h2>
        <p class="text-base-content/70 mt-1">
            Visualizando registros del cliente: <strong class="text-base-content">{{ usuario.nombre }}</strong>
        </p>
    </div>

    <div class="overflow-x-auto bg-base-100 rounded-xl border border-base-200 shadow-sm">
        <table class="table table-zebra w-full text-center">
            <thead class="bg-base-200 text-base-content font-bold uppercase text-xs tracking-wider">
                <tr>
                    <th class="py-4">Fecha</th>
                    <th>Consumo</th>
                    <th>Tarifa</th>
                    <th>Medidor</th>
                    <th class="min-w-[120px]">Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for consumo in consumos %}
                <tr class="hover transition-colors">
                    <td class="text-base-content/80">{{ consumo.fecha_consumo|date:"d/m/Y" }}</td>

                    <td>
                        <div class="badge badge-ghost font-bold text-primary whitespace-nowrap">
                            {{ consumo.cantidad_consumida }} m³
                        </div>
                    </td>

                    <td class="font-medium whitespace-nowrap">
                        {{ consumo.tarifa_aplicada.valor|formato_moneda }}
                    </td>

                    <td class="font-mono text-xs text-base-content/70">
                        {{ consumo.medidor.codigo_serial }}
                    </td>

                    <td>
                        <button onclick="abrirModalEliminar(
                               '{% url 'consumos:eliminar_consumo' consumo.id %}', 
                               '{{ consumo.fecha_consumo|date:'d/m/Y' }}', 
                               '{{ consumo.cantidad_consumida }}'
                           )" class="btn btn-sm btn-error text-white inline-flex items-center gap-2">
                            <i class="bi bi-trash3-fill"></i>
                            <span>Eliminar</span>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-12">
                        <div class="flex flex-col items-center justify-center text-base-content/50">
                            <i class="bi bi-clipboard-x text-4xl mb-3"></i>
                            <p class="font-medium">No hay consumos registrados.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="flex justify-start mt-2">
        <a href="{% url 'consumos:lista_usuarios_consumos' %}"
            class="btn btn-ghost gap-2 text-base-content/70 hover:bg-base-200">
            <i class="bi bi-arrow-left"></i> Volver al listado
        </a>
    </div>

</div>

<style>
    /* Forzamos al navegador a usar este color semitransparente para el fondo del modal (backdrop).
       El '!important' es crucial para vencer a los estilos de Bootstrap.
    */
    dialog::backdrop {
        background-color: rgba(241, 236, 236, 0) !important;
        backdrop-filter: blur(4px);
        /* Añade un bonito desenfoque al fondo */
    }
</style>

<dialog id="modal_eliminar" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box bg-base-100 p-8 shadow-2xl">

        <div class="flex flex-col items-center text-center">
            <div
                class="w-20 h-20 rounded-full bg-error/10 flex items-center justify-center mb-5 text-error animate-pulse">
                <i class="bi bi-exclamation-triangle-fill text-4xl"></i>
            </div>

            <h3 class="font-bold text-2xl text-base-content">¿Eliminar registro?</h3>

            <p class="py-4 text-base-content/70">
                Estás a punto de eliminar el consumo del día <br>
                <strong id="modal_fecha" class="text-base-content text-lg">--/--/----</strong>
                de <strong id="modal_cantidad" class="text-base-content text-lg">-- m³</strong>.
            </p>

            <p class="text-error text-sm font-semibold">
                Esta acción no se puede deshacer.
            </p>
        </div>

        <div class="modal-action flex flex-col-reverse sm:flex-row gap-3 w-full mt-8">
            <form method="dialog" class="flex-1">
                <button class="btn btn-ghost w-full hover:bg-base-200">Cancelar</button>
            </form>

            <form id="form_eliminar_real" method="post" class="flex-1">
                {% csrf_token %}
                <button type="submit" class="btn btn-error text-white w-full shadow-md shadow-error/30">
                    <i class="bi bi-trash3-fill"></i> Sí, eliminar
                </button>
            </form>
        </div>
    </div>

    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
    function abrirModalEliminar(urlEliminar, fecha, cantidad) {
        const modal = document.getElementById('modal_eliminar');
        const form = document.getElementById('form_eliminar_real');
        const spanFecha = document.getElementById('modal_fecha');
        const spanCantidad = document.getElementById('modal_cantidad');

        form.action = urlEliminar;
        spanFecha.innerText = fecha;
        spanCantidad.innerText = cantidad + ' m³';

        modal.showModal();
    }
</script>

{% endblock %}